<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EasyLap Monitor</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
      }
      .status {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      #console {
        background-color: #1e1e1e;
        color: #fff;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        height: 300px;
        overflow-y: auto;
        margin-top: 20px;
      }
      .button {
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 0;
      }
      .button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .debug {
        color: #888;
      }
      .error {
        color: #ff6b6b;
      }
      .success {
        color: #4caf50;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>EasyLap Monitor</h1>
      <button id="connectButton" class="button">
        Connect to EasyLap Device
      </button>
      <div id="console"></div>
    </div>

    <script>
      const EASYLAP_PID = 0x86b9;
      let device = null;
      const consoleDiv = document.getElementById("console");
      const connectButton = document.getElementById("connectButton");

      function log(message, type = "") {
        const timestamp = new Date().toLocaleTimeString();
        const className = type ? ` class="${type}"` : "";
        consoleDiv.innerHTML += `<div${className}>[${timestamp}] ${message}</div>`;
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
        console.log(`[${timestamp}] ${message}`);
      }

      function logDebug(message) {
        log(message, "debug");
      }

      function logError(message) {
        log(message, "error");
      }

      function logSuccess(message) {
        log(message, "success");
      }

      function arrayToHex(array) {
        if (!array || array.length === 0) return "empty";
        return Array.from(array)
          .map(b => b.toString(16).padStart(2, "0"))
          .join(" ");
      }

      async function connectToDevice() {
        try {
          logDebug("Requesting EasyLap device...");
          const devices = await navigator.hid.requestDevice({
            filters: [{ vendorId: 0x10c4, productId: EASYLAP_PID }]
          });

          if (devices.length === 0) {
            logError("No device selected");
            return;
          }

          device = devices[0];
          logDebug(`Selected device: ${device.productName}`);
          await device.open();
          logSuccess("Connected to EasyLap device");

          // // Configure UART
          // const uartConfig = new Uint8Array([
          //   0x41, // Set UART Config
          //   0x00, // Baud rate (38400)
          //   0x00, // Parity (None)
          //   0x00, // Flow control (Disabled)
          //   0x08, // Data bits (8)
          //   0x00 // Stop bits (1)
          // ]);
          // logDebug(`Sending UART config: ${arrayToHex(uartConfig)}`);
          // await device.sendFeatureReport(0x41, uartConfig);
          // logSuccess("UART configured successfully");

          // // Enable UART
          // const enableUart = new Uint8Array([0x01]);
          // logDebug(`Enabling UART: ${arrayToHex(enableUart)}`);
          // await device.sendFeatureReport(0x50, enableUart);
          // logSuccess("UART enabled");

          // Set up input report listener
          device.addEventListener("inputreport", handleInputReport);
          logDebug("Input report listener set up");

          connectButton.disabled = true;
        } catch (error) {
          logError(`Error connecting to device: ${error.message}`);
          console.error("Connection error details:", error);
        }
      }

      function handleInputReport(event) {
        try {
          const data = new Uint8Array(event.data.buffer);
          logDebug(`Received input report: ${arrayToHex(data)}`);
          processData(data);
        } catch (error) {
          logError(`Error processing input report: ${error.message}`);
          console.error("Input report error details:", error);
        }
      }

      function processData(data) {
        if (!data || data.length === 0) {
          logDebug("Received empty data packet");
          return;
        }

        const buf = new Uint8Array(data);
        logDebug(`Processing packet type: 0x${buf[0].toString(16)}`);

        if (buf[0] === 0x0b) {
          // Timer packet
          logDebug("Processing timer packet");
          if (buf.length >= 3 && buf[2] !== 0x83) {
            logDebug(`Invalid timer packet marker: 0x${buf[2].toString(16)}`);
            return;
          }
          if (buf.length >= 0x0b) {
            const timerValue =
              buf[3] | (buf[4] << 8) | (buf[5] << 16) | (buf[6] << 24);
            logSuccess(`Timer: ${timerValue}`);
            logDebug(`Timer bytes: ${arrayToHex(buf.slice(3, 7))}`);
          } else {
            logDebug(`Incomplete timer packet: ${buf.length} bytes`);
          }
        } else if (buf[0] === 0x0d) {
          // Car packet
          logDebug("Processing car packet");
          if (buf.length >= 3 && buf[2] !== 0x84) {
            logDebug(`Invalid car packet marker: 0x${buf[2].toString(16)}`);
            return;
          }
          if (buf.length >= 0x0d) {
            const uid = buf[3] | (buf[4] << 8);
            const timerValue =
              buf[7] | (buf[8] << 8) | (buf[9] << 16) | (buf[10] << 24);
            logSuccess(`Car ${uid}: ${timerValue}`);
            logDebug(`Car ID bytes: ${arrayToHex(buf.slice(3, 5))}`);
            logDebug(`Timer bytes: ${arrayToHex(buf.slice(7, 11))}`);
          } else {
            logDebug(`Incomplete car packet: ${buf.length} bytes`);
          }
        } else {
          logDebug(`Unknown packet type: 0x${buf[0].toString(16)}`);
        }
      }

      // Handle device disconnection
      navigator.hid.addEventListener("disconnect", event => {
        if (event.device === device) {
          logError("Device disconnected");
          if (device) {
            device.removeEventListener("inputreport", handleInputReport);
          }
          device = null;
          connectButton.disabled = false;
        }
      });

      connectButton.addEventListener("click", connectToDevice);
    </script>
  </body>
</html>
